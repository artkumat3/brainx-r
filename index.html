<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BrainX - Ads Verification</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #3b82f6;
      --primary-light: #60a5fa;
      --primary-dark: #2563eb;
      --secondary: #10b981;
      --secondary-light: #34d399;
      --secondary-dark: #059669;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }
    
    .verification-box {
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      box-shadow: 0 4px 30px rgba(59, 130, 246, 0.15);
      backdrop-filter: blur(8px);
    }
    
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    .shine-effect {
      position: relative;
      overflow: hidden;
    }
    
    .shine-effect:after {
      content: "";
      position: absolute;
      top: -50%;
      left: -60%;
      width: 40%;
      height: 200%;
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(30deg);
      transition: all 0.3s;
    }
    
    .shine-effect:hover:after {
      left: 120%;
    }
    
    .hover-grow {
      transition: transform 0.2s ease;
    }
    
    .hover-grow:hover {
      transform: scale(1.02);
    }
    
    .code-highlight {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: 1px;
    }
    
    .tooltip {
      position: relative;
    }
    
    .tooltip:before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      margin-bottom: 5px;
    }
    
    .tooltip:hover:before {
      opacity: 1;
      visibility: visible;
    }
    
    .logo-container {
      width: 120px;
      height: 120px;
      margin: 0 auto 1rem;
    }
    
    .logo-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      transition: width 0.3s ease;
    }
    
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }
    
    .step {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
    }
    
    .step.active {
      background: var(--primary);
      color: white;
    }
    
    .step.completed {
      background: var(--secondary);
      color: white;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="verification-box p-8 rounded-2xl w-full max-w-md text-center border border-gray-100/50 relative overflow-hidden">
    <!-- Decorative elements -->
    <div class="absolute -top-20 -right-20 w-40 h-40 rounded-full bg-blue-100/30 blur-xl"></div>
    <div class="absolute -bottom-16 -left-16 w-32 h-32 rounded-full bg-emerald-100/30 blur-xl"></div>
    
    <div class="relative z-10">
      <!-- Logo -->
      <div class="logo-container">
        <div class="bg-gradient-to-br from-blue-100 to-emerald-100 p-4 rounded-2xl shadow-inner hover-grow">
          <i class="fas fa-brain text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-emerald-500 text-4xl"></i>
        </div>
      </div>
      
      <h1 class="text-3xl font-bold text-gray-800 mb-2">BrainX Ads Verification</h1>
      <p class="mb-6 text-gray-600 font-medium">Complete verification to earn 15 credits</p>
      
      <!-- Progress Steps -->
      <div class="step-indicator">
        <div class="step completed">1</div>
        <div class="step active">2</div>
        <div class="step">3</div>
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" style="width: 33%"></div>
      </div>

      <!-- Step 1: Watch Ad -->
      <div id="step1" class="step-content">
        <div class="bg-gradient-to-r from-blue-50 to-emerald-50 p-6 rounded-xl border border-blue-100 mb-6">
          <h3 class="font-semibold text-lg mb-3 text-blue-800">
            <i class="fas fa-ad mr-2"></i>Step 1: Watch Advertisement
          </h3>
          <p class="text-blue-700 mb-4">Click the button below to watch a short advertisement and help support BrainX.</p>
          <button id="watchAdBtn" class="w-full bg-gradient-to-r from-blue-500 to-emerald-500 hover:from-blue-600 hover:to-emerald-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-3 shadow-md hover:shadow-lg active:scale-[0.98] shine-effect">
            <i class="fas fa-play-circle"></i>
            Watch Advertisement
          </button>
        </div>
      </div>

      <!-- Step 2: Generate Code (Hidden initially) -->
      <div id="step2" class="step-content hidden">
        <div class="bg-gradient-to-r from-emerald-50 to-blue-50 p-6 rounded-xl border border-emerald-100 mb-6">
          <h3 class="font-semibold text-lg mb-3 text-emerald-800">
            <i class="fas fa-gift mr-2"></i>Step 2: Get Your Reward
          </h3>
          <p class="text-emerald-700 mb-4">Thank you for watching! Generate your reward code below.</p>
          <button id="generateBtn" class="w-full bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-3 shadow-md hover:shadow-lg active:scale-[0.98] shine-effect">
            <i class="fas fa-key"></i>
            Generate Reward Code
          </button>
        </div>
      </div>

      <!-- Loading Spinner -->
      <div id="loadingSpinner" class="mt-8 hidden flex-col items-center">
        <div class="relative">
          <div class="h-12 w-12 rounded-full border-4 border-blue-100"></div>
          <div class="h-12 w-12 rounded-full border-4 border-blue-500 border-t-transparent absolute top-0 left-0 animate-spin"></div>
        </div>
        <p class="mt-4 text-gray-600 font-medium pulse">Processing your request...</p>
      </div>

      <!-- Code Display -->
      <div id="codeBox" class="mt-8 hidden animate-fade-in">
        <div class="relative bg-gradient-to-br from-gray-50 to-white p-5 rounded-xl border border-gray-200/60 shadow-sm hover-grow">
          <div class="absolute -top-3 -right-3 bg-white rounded-full p-1 shadow-md">
            <div class="bg-emerald-500 rounded-full p-1.5 animate-pulse"></div>
          </div>
          <p class="text-gray-500 text-sm font-medium mb-2">YOUR REWARD CODE</p>
          <div class="flex items-center justify-center gap-3">
            <h2 id="redeemCode" class="text-3xl font-mono font-bold code-highlight tracking-wider"></h2>
            <button id="copyBtn" class="tooltip text-gray-400 hover:text-blue-600 transition-colors hover:scale-110 active:scale-95" data-tooltip="Copy to clipboard">
              <i class="far fa-copy text-lg"></i>
            </button>
          </div>
          <div class="mt-4 flex justify-center items-center text-xs">
            <div class="text-center">
              <p class="text-gray-400">VALIDITY</p>
              <p class="text-gray-600 font-medium" id="expiresInfo"></p>
            </div>
          </div>
        </div>
        
        <!-- Step 3: Redemption Instructions -->
        <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-emerald-50 rounded-xl text-left text-sm text-blue-800 border border-blue-100 hover-grow">
          <h3 class="font-semibold mb-2 flex items-center gap-2">
            <i class="fas fa-info-circle text-blue-500"></i>
            Step 3: How to redeem your code
          </h3>
          <ol class="space-y-2 pl-1">
            <li class="flex gap-2 items-start">
              <span class="bg-blue-100 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">1</span>
              <span>Login to your <a href="https://brainx-r.vercel.app/" class="text-blue-600 hover:underline" target="_blank">BrainX account</a></span>
            </li>
            <li class="flex gap-2 items-start">
              <span class="bg-blue-100 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">2</span>
              <span>Go to sidebar â†’ Click on "Get Credit"</span>
            </li>
            <li class="flex gap-2 items-start">
              <span class="bg-blue-100 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">3</span>
              <span>Enter your unique code above</span>
            </li>
            <li class="flex gap-2 items-start">
              <span class="bg-blue-100 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">4</span>
              <span>Click "Redeem" to add 15 credits to your account</span>
            </li>
          </ol>
        </div>
        
        <div class="mt-4 text-center text-xs text-gray-400">
          <p>Code expires in 24 hours. Use it soon!</p>
        </div>
      </div>

      <!-- Error Box -->
      <div id="errorBox" class="mt-6 hidden animate-fade-in">
        <div class="bg-gradient-to-br from-red-50 to-rose-50 p-4 rounded-xl border border-red-200/70 shadow-sm">
          <p class="text-red-600 font-medium flex items-center justify-center gap-2">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorMessage"></span>
          </p>
          <button onclick="location.reload()" class="mt-3 text-sm text-red-600 hover:text-red-800 font-medium flex items-center justify-center gap-1">
            <i class="fas fa-sync-alt"></i> Try Again
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const watchAdBtn = document.getElementById('watchAdBtn');
      const generateBtn = document.getElementById('generateBtn');
      const codeBox = document.getElementById('codeBox');
      const redeemCode = document.getElementById('redeemCode');
      const expiresInfo = document.getElementById('expiresInfo');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const errorBox = document.getElementById('errorBox');
      const errorMessage = document.getElementById('errorMessage');
      const copyBtn = document.getElementById('copyBtn');
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const progressFill = document.querySelector('.progress-fill');
      const steps = document.querySelectorAll('.step');
      
      const API_BASE_URL = 'https://app.base44.com/api/apps/68cbebefa029f14aca657882/entities/RedemptionCode';
      const API_KEY = 'a59ffe885a234413baaa0ff678844bc5';
      const AD_URL = 'https://gplinks.co/RM0dc';
      const BRAINX_URL = 'https://brainx-r.vercel.app/?ads_verified';

      let adCompleted = false;

      // Fetch available redemption codes from API
      async function fetchRedemptionCodes() {
        try {
          const response = await fetch(API_BASE_URL, {
            headers: {
              'api_key': API_KEY,
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}`);
          }
          
          const data = await response.json();
          return data.filter(code => code._id);
        } catch (error) {
          console.error('Error fetching redemption codes:', error);
          throw error;
        }
      }

      // Update redemption code entity
      async function updateRedemptionCode(entityId, updateData) {
        if (!entityId) {
          throw new Error('Invalid entity ID');
        }
        
        try {
          const response = await fetch(`${API_BASE_URL}/${entityId}`, {
            method: 'PUT',
            headers: {
              'api_key': API_KEY,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
          });
          
          if (!response.ok) {
            throw new Error(`API update failed with status ${response.status}`);
          }
          
          return await response.json();
        } catch (error) {
          console.error('Error updating redemption code:', error);
          throw error;
        }
      }

      // Watch Ad Button Handler
      watchAdBtn.addEventListener('click', () => {
        // Open ad in new tab
        window.open(AD_URL, '_blank');
        
        // Show loading state
        watchAdBtn.disabled = true;
        watchAdBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Redirecting to Ad...';
        
        // Simulate ad completion after 5 seconds (in real scenario, you'd use proper tracking)
        setTimeout(() => {
          adCompleted = true;
          completeStep1();
        }, 5000);
      });

      function completeStep1() {
        // Update progress
        progressFill.style.width = '66%';
        steps[1].classList.remove('active');
        steps[1].classList.add('completed');
        steps[2].classList.add('active');
        
        // Hide step 1, show step 2
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
        
        // Reset watch button (for if user goes back)
        watchAdBtn.disabled = false;
        watchAdBtn.innerHTML = '<i class="fas fa-play-circle"></i> Watch Advertisement';
      }

      // Generate Code Button Handler
      generateBtn.addEventListener('click', async () => {
        if (!adCompleted) {
          showError('Please complete the ad verification first.');
          return;
        }

        // Reset UI
        codeBox.classList.add('hidden');
        errorBox.classList.add('hidden');
        generateBtn.disabled = true;
        generateBtn.classList.remove('from-emerald-500', 'to-blue-500', 'hover:from-emerald-600', 'hover:to-blue-600');
        generateBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        loadingSpinner.classList.remove('hidden');
        
        try {
          // Fetch available codes from API
          const data = await fetchRedemptionCodes();
          
          const now = new Date();
          const validCodes = data.filter(code =>
            code &&
            !code.is_used &&
            new Date(code.expires_at) > now &&
            code.current_uses < code.max_uses
          );

          if (validCodes.length === 0) {
            showError('No available reward codes at this time. Please try again later.');
            return;
          }

          // Select a random code
          const selected = validCodes[Math.floor(Math.random() * validCodes.length)];

          // Format the display
          const formattedCode = selected.code.match(/.{1,4}/g).join('-');
          redeemCode.textContent = formattedCode;
          
          // Format expiration date
          const expDate = new Date(selected.expires_at);
          const nowDate = new Date();
          const timeDiff = expDate - nowDate;
          const hoursRemaining = Math.floor(timeDiff / (1000 * 60 * 60));
          
          let expiresText;
          if (hoursRemaining < 24) {
            expiresText = `Expires in ${hoursRemaining} hour${hoursRemaining !== 1 ? 's' : ''}`;
          } else {
            expiresText = expDate.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          }
          
          expiresInfo.textContent = expiresText;
          
          // Update usage count
          if (selected._id) {
            await updateRedemptionCode(selected._id, {
              current_uses: selected.current_uses + 1
            });
          }
          
          // Complete final step
          progressFill.style.width = '100%';
          steps[2].classList.remove('active');
          steps[2].classList.add('completed');
          
          // Show the code box
          codeBox.classList.remove('hidden');

        } catch (err) {
          console.error("Error:", err);
          showError(err.message.includes('Network') 
            ? "Connection issue. Please check your network and try again." 
            : "Something went wrong. Please try again.");
        } finally {
          loadingSpinner.classList.add('hidden');
          generateBtn.disabled = false;
          generateBtn.classList.add('from-emerald-500', 'to-blue-500', 'hover:from-emerald-600', 'hover:to-blue-600');
          generateBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        }
      });

      copyBtn?.addEventListener('click', () => {
        const code = redeemCode.textContent.replace(/-/g, '');
        navigator.clipboard.writeText(code)
          .then(() => {
            const copyIcon = copyBtn.querySelector('i');
            copyIcon.classList.remove('far', 'fa-copy');
            copyIcon.classList.add('fas', 'fa-check', 'text-emerald-500');
            
            setTimeout(() => {
              copyIcon.classList.remove('fas', 'fa-check', 'text-emerald-500');
              copyIcon.classList.add('far', 'fa-copy');
            }, 2000);
          })
          .catch(err => {
            console.error('Could not copy text: ', err);
            copyBtn.setAttribute('data-tooltip', 'Failed to copy');
            setTimeout(() => copyBtn.setAttribute('data-tooltip', 'Copy to clipboard'), 2000);
          });
      });

      function showError(message) {
        errorMessage.textContent = message;
        errorBox.classList.remove('hidden');
        
        setTimeout(() => {
          if (!codeBox.classList.contains('hidden')) return;
          errorBox.classList.add('hidden');
        }, 5000);
      }
      
      // Add animation to main box
      document.querySelector('.verification-box').style.animation = 'fadeIn 0.8s ease-out';
    });
  </script>
</body>
</html>